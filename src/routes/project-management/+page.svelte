<script>
  /* global console, fetch, URL */
  import { goto } from '$app/navigation'
  import { page } from '$app/stores'
  import PageLayout from '$lib/components/layout/PageLayout.svelte'
  import ProjectCreationForm from '$lib/components/project-management/ProjectCreationForm.svelte'
  import ProjectDetailView from '$lib/components/project-management/ProjectDetailView.svelte'
  import ThemeBadge from '$lib/components/ui/ThemeBadge.svelte'
  import ThemeButton from '$lib/components/ui/ThemeButton.svelte'
  import ThemeCard from '$lib/components/ui/ThemeCard.svelte'
  import ThemeModal from '$lib/components/ui/ThemeModal.svelte'
  import ThemeTabs from '$lib/components/ui/ThemeTabs.svelte'
  import { formatCurrency, formatDate } from '$lib/utils/format'
  import {
  	ActivityIcon,
  	AlertTriangleIcon,
  	BarChart3Icon,
  	DollarSignIcon,
  	FlaskConicalIcon,
  	PercentIcon,
  	PlusIcon,
  	UsersIcon
  } from '@lucide/svelte'
  import { onMount } from 'svelte'

  /**
   * @typedef {Object} Project
   * @property {string} id
   * @property {string} title
   * @property {string} code
   * @property {string} [description]
   * @property {string} [startDate]
   * @property {string} [endDate]
   * @property {'planning' | 'active' | 'completed'} status
   * @property {'internal' | 'government' | 'private' | 'international'} [sponsorType]
   * @property {'low' | 'medium' | 'high' | 'critical'} [priority]
   * @property {'basic' | 'applied' | 'development'} [researchType]
   * @property {string} [updatedAt]
   */

  /**
   * @typedef {Object} ProjectSummary
   * @property {number} totalProjects
   * @property {number} activeProjects
   * @property {number} totalBudget
   * @property {number} currentYearBudget
   * @property {number} totalMembers
   * @property {number} activeMembers
   * @property {number} overParticipationEmployees
   * @property {Array<{title: string, code: string, status: string, updatedAt: string}>} [recentActivities]
   */

  /**
   * @typedef {Object} EmployeeParticipation
   * @property {string} name
   * @property {string} email
   * @property {string} department
   * @property {number} activeProjects
   * @property {number} totalParticipationRate
   */

  // ÌÉ≠ Ï†ïÏùò
  const tabs = [
    {
      id: 'overview',
      label: 'Í∞úÏöî',
      icon: BarChart3Icon
    },
    {
      id: 'projects',
      label: 'ÌîÑÎ°úÏ†ùÌä∏',
      icon: FlaskConicalIcon
    },
    {
      id: 'participation',
      label: 'Ï∞∏Ïó¨Ïú® Í¥ÄÎ¶¨',
      icon: PercentIcon
    }
  ]

  // URL ÌååÎùºÎØ∏ÌÑ∞ÏóêÏÑú ÌôúÏÑ± ÌÉ≠ Í¥ÄÎ¶¨
  let activeTab = $state($page.url.searchParams.get('tab') || 'overview')

  // ÏÉÅÌÉú Î≥ÄÏàòÎì§
  let mounted = $state(false)
  let projects = $state([])
  let projectSummary = $state(null)
  let employeeParticipationSummary = $state([])
  let alerts = $state([])
  let error = $state(null)

  // ÌÉ≠Î≥Ñ Î°úÎî© ÏÉÅÌÉú Î∞è Ïò§Î•ò Ï≤¥ÌÅ¨
  let tabLoadingStates = $state({
    overview: false,
    projects: false,
    participation: false
  })
  let tabErrors = $state({
    overview: null,
    projects: null,
    participation: null
  })
  let tabLastLoaded = $state({
    overview: null,
    projects: null,
    participation: null
  })

  // ÌÉ≠Î≥Ñ Îç∞Ïù¥ÌÑ∞ Î°úÎî© Ìï®ÏàòÎì§
  async function loadTabData(tabName) {
    if (tabLoadingStates[tabName]) return

    tabLoadingStates[tabName] = true
    tabErrors[tabName] = null

    try {
      switch (tabName) {
        case 'overview':
          await Promise.all([
            loadProjectSummary(),
            loadEmployeeParticipationSummary(),
            loadBudgetSummaryByYear(),
            loadAlerts()
          ])
          break
        case 'projects':
          await loadProjectData()
          break
        case 'participation':
          await loadEmployeeParticipationSummary()
          break
      }
      tabLastLoaded[tabName] = new Date()
    } catch (err) {
      const errorMessage = err instanceof Error ? err.message : 'Ïïå Ïàò ÏóÜÎäî Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.'
      tabErrors[tabName] = errorMessage
      console.error(`${tabName} ÌÉ≠ Îç∞Ïù¥ÌÑ∞ Î°úÎî© Ïã§Ìå®:`, err)
    } finally {
      tabLoadingStates[tabName] = false
    }
  }

  // Svelte 5: ÌÉ≠ Î≥ÄÍ≤Ω Ïãú Îç∞Ïù¥ÌÑ∞ Î°úÎìú (Î¨¥Ìïú Î£®ÌîÑ Î∞©ÏßÄ)
  let lastLoadedTab = $state('')
  $effect(() => {
    if (mounted && activeTab && activeTab !== lastLoadedTab) {
      lastLoadedTab = activeTab
      loadTabData(activeTab)
    }
  })

  // Svelte 5: Ïª¥Ìè¨ÎÑåÌä∏ ÎßàÏö¥Ìä∏ Ïãú mounted ÏÉÅÌÉú ÏÑ§Ï†ï
  onMount(() => {
    mounted = true
  })

  // ÌîÑÎ°úÏ†ùÌä∏ Í¥ÄÎ†® ÏÉÅÌÉú
  let selectedProject = $state(null)
  let selectedProjectId = $state('')
  let showCreateProjectModal = $state(false)
  let showBudgetModal = $state(false)

  // ÌÉ≠ Î≥ÄÍ≤Ω Ìï∏Îì§Îü¨
  function handleTabChange(tabId) {
    activeTab = tabId
    const url = new URL($page.url)
    url.searchParams.set('tab', tabId)
    goto(url.toString(), { replaceState: true })
  }

  // API Ìò∏Ï∂ú Ìï®ÏàòÎì§
  async function loadProjectData() {
    try {
      console.log('üîç ÌîÑÎ°úÏ†ùÌä∏ Îç∞Ïù¥ÌÑ∞ Î°úÎî© ÏãúÏûë...')

      // API ÏùëÎãµ ÏãúÍ∞Ñ Ï∏°Ï†ï
      const startTime = Date.now()
      const response = await fetch('/api/project-management/projects')
      const responseTime = Date.now() - startTime

      console.log(`‚è±Ô∏è API ÏùëÎãµ ÏãúÍ∞Ñ: ${responseTime}ms`)

      if (response.ok) {
        const data = await response.json()
        console.log('üìä API ÏùëÎãµ Îç∞Ïù¥ÌÑ∞:', data)

        if (data.success) {
          const projectData = data.data || []

          // ÌîÑÎ°úÏ†ùÌä∏ Îç∞Ïù¥ÌÑ∞ Í≤ÄÏ¶ù
          const validationResult = validateProjectData(projectData)
          if (!validationResult.isValid) {
            console.error('‚ùå ÌîÑÎ°úÏ†ùÌä∏ Îç∞Ïù¥ÌÑ∞ Í≤ÄÏ¶ù Ïã§Ìå®:', validationResult.issues)
            // Í≤ÄÏ¶ù Ïã§Ìå® Ïãú Îπà Î∞∞Ïó¥Î°ú ÏÑ§Ï†ïÌïòÏó¨ Î¨¥Ìïú Î£®ÌîÑ Î∞©ÏßÄ
            projects = []
            error = `Îç∞Ïù¥ÌÑ∞ Í≤ÄÏ¶ù Ïã§Ìå®: ${validationResult.issues.join(', ')}`
            return // throw ÎåÄÏã† returnÏúºÎ°ú Ìï®Ïàò Ï¢ÖÎ£å
          }

          projects = projectData
          error = null
          console.log(`‚úÖ ${projectData.length}Í∞ú ÌîÑÎ°úÏ†ùÌä∏ Î°úÎìú ÏôÑÎ£å`)
        } else {
          throw new Error(data.message || 'ÌîÑÎ°úÏ†ùÌä∏ Îç∞Ïù¥ÌÑ∞Î•º Î∂àÎü¨Ïò§ÎäîÎç∞ Ïã§Ìå®ÌñàÏäµÎãàÎã§.')
        }
      } else if (response.status === 404) {
        throw new Error('ÌîÑÎ°úÏ†ùÌä∏ Í¥ÄÎ¶¨ APIÍ∞Ä ÏïÑÏßÅ Íµ¨ÌòÑÎêòÏßÄ ÏïäÏïòÏäµÎãàÎã§.')
      } else if (response.status === 500) {
        throw new Error('ÏÑúÎ≤Ñ ÎÇ¥Î∂Ä Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§. Ïû†Ïãú ÌõÑ Îã§Ïãú ÏãúÎèÑÌï¥Ï£ºÏÑ∏Ïöî.')
      } else if (response.status === 403) {
        throw new Error('ÌîÑÎ°úÏ†ùÌä∏ Îç∞Ïù¥ÌÑ∞Ïóê Ï†ëÍ∑ºÌï† Í∂åÌïúÏù¥ ÏóÜÏäµÎãàÎã§.')
      } else {
        throw new Error(`HTTP ${response.status}: ${response.statusText}`)
      }
    } catch (err) {
      // Îü∞ÌÉÄÏûÑ Ïò§Î•ò Ï≤òÎ¶¨ - ÏûêÎèô Í≤ÄÏ¶ùÏùÑ ÏúÑÌïú Î™ÖÌôïÌïú Ìå®ÌÑ¥
      const errorMessage = err instanceof Error ? err.message : 'ÎÑ§Ìä∏ÏõåÌÅ¨ Ïò§Î•òÎ°ú ÌîÑÎ°úÏ†ùÌä∏ Îç∞Ïù¥ÌÑ∞Î•º Î∂àÎü¨Ïò¨ Ïàò ÏóÜÏäµÎãàÎã§.'

      // Failed to fetch Ïò§Î•ò ÌäπÎ≥Ñ Ï≤òÎ¶¨
      if (err instanceof Error && err.message && err.message.includes('Failed to fetch')) {
        error = 'ÏÑúÎ≤ÑÏóê Ïó∞Í≤∞Ìï† Ïàò ÏóÜÏäµÎãàÎã§. ÏÑúÎ≤ÑÍ∞Ä Ïã§Ìñâ Ï§ëÏù∏ÏßÄ ÌôïÏù∏Ìï¥Ï£ºÏÑ∏Ïöî.'
        console.error('‚ùå ÎÑ§Ìä∏ÏõåÌÅ¨ Ïó∞Í≤∞ Ïã§Ìå®:', err.message)
      } else {
        error = errorMessage
        console.error('‚ùå ÌîÑÎ°úÏ†ùÌä∏ Îç∞Ïù¥ÌÑ∞ Î°úÎìú Ïã§Ìå®:', err)
      }

      projects = []
      throw err // ÏÉÅÏúÑ Ìï®ÏàòÏóêÏÑú Ï≤òÎ¶¨Ìï† Ïàò ÏûàÎèÑÎ°ù Ïû¨throw
    }
  }

  // Í∞úÏÑ†Îêú ÌîÑÎ°úÏ†ùÌä∏ Îç∞Ïù¥ÌÑ∞ Í≤ÄÏ¶ù Ìï®Ïàò (Í∏∞Ìöç Îã®Í≥Ñ ÏôÑÌôî)
  function validateProjectData(projectData) {
    const issues = []
    const warnings = []

    if (!Array.isArray(projectData)) {
      issues.push('ÌîÑÎ°úÏ†ùÌä∏ Îç∞Ïù¥ÌÑ∞Í∞Ä Î∞∞Ïó¥Ïù¥ ÏïÑÎãôÎãàÎã§.')
      return { isValid: false, issues }
    }

    projectData.forEach((project, index) => {
      const projectName = project.title || project.code || `ÌîÑÎ°úÏ†ùÌä∏ ${index + 1}`
      const isPlanning = project.status === 'planning'

      // Î™®Îì† ÌîÑÎ°úÏ†ùÌä∏Ïóê Í≥µÌÜµÏúºÎ°ú ÌïÑÏöîÌïú ÌïÑÏàò ÌïÑÎìú
      if (!project.id) {
        issues.push(`${projectName}: IDÍ∞Ä ÎàÑÎùΩÎêòÏóàÏäµÎãàÎã§.`)
      }
      if (!project.title) {
        issues.push(`${projectName}: Ï†úÎ™©Ïù¥ ÎàÑÎùΩÎêòÏóàÏäµÎãàÎã§.`)
      }
      if (!project.code) {
        issues.push(`${projectName}: ÏΩîÎìúÍ∞Ä ÎàÑÎùΩÎêòÏóàÏäµÎãàÎã§.`)
      }

      // Í∏∞Ìöç Îã®Í≥ÑÍ∞Ä ÏïÑÎãå Í≤ΩÏö∞ÏóêÎßå ÌïÑÏàòÏù∏ ÌïÑÎìúÎì§
      if (!isPlanning) {
        if (!project.startDate) {
          issues.push(`${projectName}: ÏßÑÌñâ/ÏôÑÎ£å ÏÉÅÌÉú ÌîÑÎ°úÏ†ùÌä∏Îäî ÏãúÏûëÏùºÏù¥ ÌïÑÏöîÌï©ÎãàÎã§.`)
        }
        if (!project.endDate) {
          issues.push(`${projectName}: ÏßÑÌñâ/ÏôÑÎ£å ÏÉÅÌÉú ÌîÑÎ°úÏ†ùÌä∏Îäî Ï¢ÖÎ£åÏùºÏù¥ ÌïÑÏöîÌï©ÎãàÎã§.`)
        }
      } else {
        // Í∏∞Ìöç Îã®Í≥ÑÏóêÏÑúÎäî Í≤ΩÍ≥†Îßå ÌëúÏãú
        if (!project.startDate) {
          warnings.push(`${projectName}: ÏãúÏûëÏùºÏù¥ ÏÑ§Ï†ïÎêòÏßÄ ÏïäÏïòÏäµÎãàÎã§. (Í∏∞Ìöç Îã®Í≥ÑÏù¥ÎØÄÎ°ú ÏÑ†ÌÉùÏÇ¨Ìï≠)`)
        }
        if (!project.endDate) {
          warnings.push(`${projectName}: Ï¢ÖÎ£åÏùºÏù¥ ÏÑ§Ï†ïÎêòÏßÄ ÏïäÏïòÏäµÎãàÎã§. (Í∏∞Ìöç Îã®Í≥ÑÏù¥ÎØÄÎ°ú ÏÑ†ÌÉùÏÇ¨Ìï≠)`)
        }
      }

      // ÎÇ†Ïßú Ïú†Ìö®ÏÑ± Í≤ÄÏ¶ù (ÎÇ†ÏßúÍ∞Ä ÏûàÎäî Í≤ΩÏö∞ÏóêÎßå)
      if (project.startDate && project.endDate) {
        const startDate = new Date(project.startDate)
        const endDate = new Date(project.endDate)

        if (isNaN(startDate.getTime())) {
          issues.push(`${projectName}: ÏãúÏûëÏùº ÌòïÏãùÏù¥ Ïò¨Î∞îÎ•¥ÏßÄ ÏïäÏäµÎãàÎã§.`)
        }
        if (isNaN(endDate.getTime())) {
          issues.push(`${projectName}: Ï¢ÖÎ£åÏùº ÌòïÏãùÏù¥ Ïò¨Î∞îÎ•¥ÏßÄ ÏïäÏäµÎãàÎã§.`)
        }
        if (!isNaN(startDate.getTime()) && !isNaN(endDate.getTime()) && startDate > endDate) {
          issues.push(`${projectName}: ÏãúÏûëÏùºÏù¥ Ï¢ÖÎ£åÏùºÎ≥¥Îã§ Îä¶ÏäµÎãàÎã§.`)
        }
      }

      // ÏÉÅÌÉú Í∞í Í≤ÄÏ¶ù
      const validStatuses = ['planning', 'active', 'completed']
      if (project.status && !validStatuses.includes(project.status)) {
        issues.push(`${projectName}: Ïú†Ìö®ÌïòÏßÄ ÏïäÏùÄ ÏÉÅÌÉúÍ∞íÏûÖÎãàÎã§. (${project.status})`)
      }

      // Ïö∞ÏÑ†ÏàúÏúÑ Í∞í Í≤ÄÏ¶ù (ÏûàÎäî Í≤ΩÏö∞ÏóêÎßå)
      if (project.priority) {
        const validPriorities = ['low', 'medium', 'high', 'critical']
        if (!validPriorities.includes(project.priority)) {
          issues.push(`${projectName}: Ïú†Ìö®ÌïòÏßÄ ÏïäÏùÄ Ïö∞ÏÑ†ÏàúÏúÑÍ∞íÏûÖÎãàÎã§. (${project.priority})`)
        }
      }
    })

    // Í≤ΩÍ≥†Í∞Ä ÏûàÏúºÎ©¥ ÏΩòÏÜîÏóê Ï∂úÎ†•
    if (warnings.length > 0) {
      console.warn('‚ö†Ô∏è ÌîÑÎ°úÏ†ùÌä∏ Îç∞Ïù¥ÌÑ∞ Í≤ΩÍ≥†:', warnings)
    }

    return {
      isValid: issues.length === 0,
      issues
    }
  }

  async function loadProjectSummary() {
    try {
      const response = await fetch('/api/project-management/summary')
      if (response.ok) {
        const data = await response.json()
        projectSummary = data.data
      }
    } catch (err) {
      console.error('ÌîÑÎ°úÏ†ùÌä∏ ÏöîÏïΩ Î°úÎìú Ïã§Ìå®:', err)
    }
  }

  async function loadEmployeeParticipationSummary() {
    try {
      const response = await fetch('/api/project-management/participation-rates/summary')
      if (response.ok) {
        const data = await response.json()
        employeeParticipationSummary = data.data || []
      }
    } catch {
    // ÏßÅÏõê Ï∞∏Ïó¨Ïú® Îç∞Ïù¥ÌÑ∞ Î°úÎìú Ïã§Ìå® - Ï°∞Ïö©Ìûà Ï≤òÎ¶¨
    }
  }

  async function loadBudgetSummaryByYear() {
    try {
      const response = await fetch('/api/project-management/budgets/summary-by-year')
      if (response.ok) {
      // const data = await response.json()
        // budgetSummaryByYear = data.data || []
      }
    } catch {
    // Ïó∞ÎèÑÎ≥Ñ ÏòàÏÇ∞ Îç∞Ïù¥ÌÑ∞ Î°úÎìú Ïã§Ìå® - Ï°∞Ïö©Ìûà Ï≤òÎ¶¨
    }
  }

  async function loadAlerts() {
    try {
      const response = await fetch('/api/project-management/alerts')
      if (response.ok) {
        const data = await response.json()
        alerts = data.data || []
      }
    } catch {
    // ÏïåÎ¶º Îç∞Ïù¥ÌÑ∞ Î°úÎìú Ïã§Ìå® - Ï°∞Ïö©Ìûà Ï≤òÎ¶¨
    }
  }

  // ÌîÑÎ°úÏ†ùÌä∏ ÏÉùÏÑ± ÏôÑÎ£å Ìï∏Îì§Îü¨
  function handleProjectCreated() {
    showCreateProjectModal = false
    loadProjectData()
    loadProjectSummary()
  }

  // ÌîÑÎ°úÏ†ùÌä∏ ÏÑ†ÌÉù
  function selectProject(project) {
    selectedProject = project
    selectedProjectId = project.id
  }

  // ÌîÑÎ°úÏ†ùÌä∏ ÏÇ≠Ï†ú Ïù¥Î≤§Ìä∏ Ï≤òÎ¶¨
  function handleProjectDeleted(event) {
    const { projectId } = event.detail

    // ÏÇ≠Ï†úÎêú ÌîÑÎ°úÏ†ùÌä∏Í∞Ä ÌòÑÏû¨ ÏÑ†ÌÉùÎêú ÌîÑÎ°úÏ†ùÌä∏ÎùºÎ©¥ ÏÑ†ÌÉù Ìï¥Ï†ú
    if (selectedProject && selectedProject.id === projectId) {
      selectedProject = null
      selectedProjectId = ''
    }

    // ÌîÑÎ°úÏ†ùÌä∏ Î™©Î°ùÏóêÏÑú ÏÇ≠Ï†úÎêú ÌîÑÎ°úÏ†ùÌä∏ Ï†úÍ±∞
    projects = projects.filter(p => p.id !== projectId)

    // ÌîÑÎ°úÏ†ùÌä∏ Îç∞Ïù¥ÌÑ∞ ÏÉàÎ°úÍ≥†Ïπ®
    loadProjectData()
  }

  // Í∞ÑÏÜåÌôîÎêú ÏÉÅÌÉú Î∞∞ÏßÄ ÏÉâÏÉÅ
  function getStatusBadgeColor(status) {
    switch (status) {
      case 'active': return 'success'
      case 'planning': return 'primary'
      case 'completed': return 'default'
      default: return 'default'
    }
  }

  // Í∞ÑÏÜåÌôîÎêú ÏÉÅÌÉú ÌïúÍ∏Ä Î≥ÄÌôò
  function getStatusLabel(status) {
    switch (status) {
      case 'active': return 'ÏßÑÌñâ'
      case 'planning': return 'Í∏∞Ìöç'
      case 'completed': return 'ÏôÑÎ£å'
      default: return status
    }
  }

  // ÏïàÏ†ÑÌïú ÎÇ†Ïßú ÌëúÏãú Ìï®Ïàò
  function safeFormatDate(dateString) {
    if (!dateString) return 'ÎØ∏Ï†ï'
    try {
      return formatDate(dateString)
    } catch {
      return 'ÏûòÎ™ªÎêú ÎÇ†Ïßú'
    }
  }

  // Ï¥àÍ∏∞Ìôî - Ï≤´ Î≤àÏß∏ ÌÉ≠Îßå Î°úÎìú
  $effect(() => {
    if (!mounted) {
      mounted = true
      // Ï¥àÍ∏∞ ÌÉ≠ Îç∞Ïù¥ÌÑ∞ Î°úÎìú
      loadTabData(activeTab)
    }
  })
</script>

<PageLayout
  title="ÌîÑÎ°úÏ†ùÌä∏ Í¥ÄÎ¶¨"
  subtitle="Ïó∞Íµ¨Í∞úÎ∞ú ÌîÑÎ°úÏ†ùÌä∏ Î∞è Ï∞∏Ïó¨Ïú® Í¥ÄÎ¶¨ ÏãúÏä§ÌÖú"
>
  <div class="space-y-6">
    <!-- ÏóêÎü¨ Î©îÏãúÏßÄ -->
    {#if error}
      <ThemeCard>
        <div class="bg-red-50 border border-red-200 rounded-md p-4">
          <div class="flex">
            <div class="flex-shrink-0">
              <AlertTriangleIcon class="h-5 w-5 text-red-400" />
            </div>
            <div class="ml-3">
              <h3 class="text-sm font-medium text-red-800">ÏãúÏä§ÌÖú ÏïàÎÇ¥</h3>
              <div class="mt-2 text-sm text-red-700">
                <p>{error}</p>
                <p class="mt-1">Í¥ÄÎ¶¨ÏûêÏóêÍ≤å Î¨∏ÏùòÌïòÏãúÍ±∞ÎÇò Ïû†Ïãú ÌõÑ Îã§Ïãú ÏãúÎèÑÌï¥Ï£ºÏÑ∏Ïöî.</p>
              </div>
            </div>
          </div>
        </div>
      </ThemeCard>
    {/if}

    <!-- ÌÉ≠ ÎÑ§ÎπÑÍ≤åÏù¥ÏÖò -->
    <ThemeTabs
      {tabs}
      {activeTab}
      onTabChange={handleTabChange}
    />

    <!-- ÌÉ≠Î≥Ñ Î°úÎî© ÏÉÅÌÉú ÌëúÏãú -->
    {#if tabLoadingStates[activeTab]}
      <ThemeCard>
        <div class="flex items-center justify-center p-8">
          <div class="flex items-center space-x-3">
            <div class="animate-spin rounded-full h-6 w-6 border-b-2 border-blue-600"></div>
            <span class="text-gray-600">Îç∞Ïù¥ÌÑ∞Î•º Î∂àÎü¨Ïò§Îäî Ï§ë...</span>
          </div>
        </div>
      </ThemeCard>
    {/if}

    <!-- Í∞úÏöî ÌÉ≠ -->
    {#if activeTab === 'overview'}
      <div class="space-y-6">
        <!-- ÌÉ≠Î≥Ñ Ïò§Î•ò ÌëúÏãú -->
        {#if tabErrors.overview}
          <ThemeCard>
            <div class="bg-red-50 border border-red-200 rounded-md p-4">
              <div class="flex">
                <div class="flex-shrink-0">
                  <AlertTriangleIcon class="h-5 w-5 text-red-400" />
                </div>
                <div class="ml-3">
                  <h3 class="text-sm font-medium text-red-800">Í∞úÏöî Îç∞Ïù¥ÌÑ∞ Î°úÎî© Ïò§Î•ò</h3>
                  <div class="mt-2 text-sm text-red-700">
                    <p>{tabErrors.overview}</p>
                    <button
                      type="button"
                      onclick={() => loadTabData('overview')}
                      class="mt-2 text-sm text-red-600 hover:text-red-800 underline"
                    >
                      Îã§Ïãú ÏãúÎèÑ
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </ThemeCard>
        {/if}
        <!-- ÏöîÏïΩ ÌÜµÍ≥Ñ -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
          <ThemeCard>
            <div class="flex items-center">
              <div class="flex-shrink-0">
                <FlaskConicalIcon class="h-8 w-8 text-blue-600" />
              </div>
              <div class="ml-4">
                <p class="text-sm font-medium text-gray-500">Ï¥ù ÌîÑÎ°úÏ†ùÌä∏</p>
                <p class="text-2xl font-semibold text-gray-900">
                  {projectSummary?.totalProjects || 0}Í∞ú
                </p>
                <div class="flex items-center mt-2">
                  <span class="text-sm text-green-600">
                    ÏßÑÌñâÏ§ë: {projectSummary?.activeProjects || 0}
                  </span>
                </div>
              </div>
            </div>
          </ThemeCard>

          <ThemeCard>
            <div class="flex items-center">
              <div class="flex-shrink-0">
                <DollarSignIcon class="h-8 w-8 text-green-600" />
              </div>
              <div class="ml-4">
                <p class="text-sm font-medium text-gray-500">Ï¥ù ÏòàÏÇ∞</p>
                <p class="text-2xl font-semibold text-gray-900">
                  {formatCurrency(projectSummary?.totalBudget || 0)}
                </p>
                <div class="flex items-center mt-2">
                  <span class="text-sm text-blue-600">
                    Ïò¨Ìï¥: {formatCurrency(projectSummary?.currentYearBudget || 0)}
                  </span>
                </div>
              </div>
            </div>
          </ThemeCard>

          <ThemeCard>
            <div class="flex items-center">
              <div class="flex-shrink-0">
                <UsersIcon class="h-8 w-8 text-purple-600" />
              </div>
              <div class="ml-4">
                <p class="text-sm font-medium text-gray-500">Ï∞∏Ïó¨ Ïó∞Íµ¨Ïõê</p>
                <p class="text-2xl font-semibold text-gray-900">
                  {projectSummary?.totalMembers || 0}Î™Ö
                </p>
                <div class="flex items-center mt-2">
                  <span class="text-sm text-gray-500">
                    ÌôúÏÑ±: {projectSummary?.activeMembers || 0}Î™Ö
                  </span>
                </div>
              </div>
            </div>
          </ThemeCard>

          <ThemeCard>
            <div class="flex items-center">
              <div class="flex-shrink-0">
                <AlertTriangleIcon class="h-8 w-8 text-orange-600" />
              </div>
              <div class="ml-4">
                <p class="text-sm font-medium text-gray-500">ÏïåÎ¶º</p>
                <p class="text-2xl font-semibold text-gray-900">
                  {alerts.length}Í∞ú
                </p>
                <div class="flex items-center mt-2">
                  <span class="text-sm text-red-600">
                    Ï¥àÍ≥º Ï∞∏Ïó¨: {projectSummary?.overParticipationEmployees || 0}Î™Ö
                  </span>
                </div>
              </div>
            </div>
          </ThemeCard>
        </div>

        <!-- ÏµúÍ∑º ÌôúÎèô -->
        <ThemeCard>
          <div class="px-6 py-4 border-b border-gray-200">
            <h3 class="text-lg font-medium text-gray-900">ÏµúÍ∑º ÌîÑÎ°úÏ†ùÌä∏ ÌôúÎèô</h3>
          </div>
          <div class="divide-y divide-gray-200">
            {#if projectSummary?.recentActivities && projectSummary.recentActivities.length > 0}
              {#each projectSummary.recentActivities as activity (activity.code)}
                <div class="px-6 py-4">
                  <div class="flex items-center justify-between">
                    <div class="flex items-center">
                      <ThemeBadge variant={getStatusBadgeColor(activity.status)}>
                        {getStatusLabel(activity.status)}
                      </ThemeBadge>
                      <div class="ml-4">
                        <p class="text-sm font-medium text-gray-900">{activity.title}</p>
                        <p class="text-sm text-gray-500">{activity.code}</p>
                      </div>
                    </div>
                    <div class="text-sm text-gray-500">
                      {safeFormatDate(activity.updatedAt)}
                    </div>
                  </div>
                </div>
              {/each}
            {:else}
              <div class="px-6 py-8 text-center text-gray-500">
                <ActivityIcon class="mx-auto h-12 w-12 text-gray-400" />
                <p class="mt-2">ÏµúÍ∑º ÌôúÎèôÏù¥ ÏóÜÏäµÎãàÎã§.</p>
              </div>
            {/if}
          </div>
        </ThemeCard>
      </div>
    {/if}

    <!-- ÌîÑÎ°úÏ†ùÌä∏ ÌÉ≠ -->
    {#if activeTab === 'projects'}
      <div class="space-y-6">
        <!-- ÌÉ≠Î≥Ñ Ïò§Î•ò ÌëúÏãú -->
        {#if tabErrors.projects}
          <ThemeCard>
            <div class="bg-red-50 border border-red-200 rounded-md p-4">
              <div class="flex">
                <div class="flex-shrink-0">
                  <AlertTriangleIcon class="h-5 w-5 text-red-400" />
                </div>
                <div class="ml-3">
                  <h3 class="text-sm font-medium text-red-800">ÌîÑÎ°úÏ†ùÌä∏ Îç∞Ïù¥ÌÑ∞ Î°úÎî© Ïò§Î•ò</h3>
                  <div class="mt-2 text-sm text-red-700">
                    <p>{tabErrors.projects}</p>
                    <button
                      type="button"
                      onclick={() => loadTabData('projects')}
                      class="mt-2 text-sm text-red-600 hover:text-red-800 underline"
                    >
                      Îã§Ïãú ÏãúÎèÑ
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </ThemeCard>
        {/if}
        <!-- ÌîÑÎ°úÏ†ùÌä∏ ÏÑ†ÌÉù Ìó§Îçî -->
        <ThemeCard>
          <div class="flex flex-col sm:flex-row gap-4 items-start sm:items-center justify-between">
            <div class="flex flex-col sm:flex-row gap-4 flex-1">
              <div class="relative flex-1 max-w-md">
                <select
                  bind:value={selectedProjectId}
                  onchange={(e) => {
                    const target = e.target
                    if (target && 'value' in target) {
                      const project = projects.find(p => p.id === target.value)
                      if (project) selectProject(project)
                    }
                  }}
                  class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                  disabled={tabLoadingStates.projects}
                >
                  <option value="">
                    {#if tabLoadingStates.projects}
                      Î°úÎî© Ï§ë...
                    {:else if projects.length === 0}
                      ÌîÑÎ°úÏ†ùÌä∏ ÏóÜÏùå (0Í∞ú)
                    {:else}
                      ÌîÑÎ°úÏ†ùÌä∏ ÏÑ†ÌÉù ({projects.length}Í∞ú)
                    {/if}
                  </option>
                  {#each projects as project (project.id)}
                    <option value={project.id}>
                      {project.title} ({getStatusLabel(project.status)})
                    </option>
                  {/each}
                </select>
              </div>

              <!-- ÌîÑÎ°úÏ†ùÌä∏ ÌÜµÍ≥Ñ ÌëúÏãú -->
              {#if projects.length > 0}
                <div class="flex items-center space-x-4 text-sm text-gray-600">
                  <span>Ï¥ù {projects.length}Í∞ú</span>
                  <span>‚Ä¢</span>
                  <span>ÌôúÏÑ±: {projects.filter(p => p.status === 'active').length}Í∞ú</span>
                  <span>‚Ä¢</span>
                  <span>ÏôÑÎ£å: {projects.filter(p => p.status === 'completed').length}Í∞ú</span>
                </div>
              {/if}
            </div>
            <div class="flex gap-2">
              <ThemeButton
                variant="primary"
                size="sm"
                onclick={() => showCreateProjectModal = true}
                disabled={tabLoadingStates.projects}
              >
                <PlusIcon
                  size={16}
                  class="mr-2" />
                ÏÉà ÌîÑÎ°úÏ†ùÌä∏
              </ThemeButton>
            </div>
          </div>
        </ThemeCard>

        <!-- ÌîÑÎ°úÏ†ùÌä∏ ÏÉÅÏÑ∏ Ï†ïÎ≥¥ -->
        {#if selectedProject}
          <div class="space-y-6">
            <!-- ÌîÑÎ°úÏ†ùÌä∏ Í∏∞Î≥∏ Ï†ïÎ≥¥ -->
            <ProjectDetailView
              {selectedProject}
              on:refresh={loadProjectData}
              on:project-deleted={handleProjectDeleted}
              on:showBudgetModal={() => showBudgetModal = true}
            />
          </div>
        {:else if projects.length === 0 && !tabLoadingStates.projects && !tabErrors.projects}
          <ThemeCard>
            <div class="text-center py-12">
              <FlaskConicalIcon class="mx-auto h-12 w-12 text-gray-400" />
              <h3 class="mt-2 text-sm font-medium text-gray-900">ÌîÑÎ°úÏ†ùÌä∏Í∞Ä ÏóÜÏäµÎãàÎã§</h3>
              <p class="mt-1 text-sm text-gray-500">
                ÏÉà ÌîÑÎ°úÏ†ùÌä∏Î•º ÏÉùÏÑ±ÌïòÏó¨ ÏãúÏûëÌïòÏÑ∏Ïöî.
              </p>
              <div class="mt-6">
                <ThemeButton
                  variant="primary"
                  onclick={() => showCreateProjectModal = true}
                >
                  <PlusIcon
                    size={16}
                    class="mr-2" />
                  Ï≤´ ÌîÑÎ°úÏ†ùÌä∏ ÏÉùÏÑ±
                </ThemeButton>
              </div>
            </div>
          </ThemeCard>
        {:else}
          <ThemeCard>
            <div class="text-center py-12">
              <FlaskConicalIcon class="mx-auto h-12 w-12 text-gray-400" />
              <h3 class="mt-2 text-sm font-medium text-gray-900">ÌîÑÎ°úÏ†ùÌä∏Î•º ÏÑ†ÌÉùÌïòÏÑ∏Ïöî</h3>
              <p class="mt-1 text-sm text-gray-500">
                ÏúÑÏóêÏÑú ÌîÑÎ°úÏ†ùÌä∏Î•º ÏÑ†ÌÉùÌïòÎ©¥ ÏÉÅÏÑ∏ Ï†ïÎ≥¥Î•º Î≥º Ïàò ÏûàÏäµÎãàÎã§.
              </p>
            </div>
          </ThemeCard>
        {/if}
      </div>
    {/if}

    <!-- Ï∞∏Ïó¨Ïú® Í¥ÄÎ¶¨ ÌÉ≠ -->
    {#if activeTab === 'participation'}
      <div class="space-y-6">
        <!-- ÌÉ≠Î≥Ñ Ïò§Î•ò ÌëúÏãú -->
        {#if tabErrors.participation}
          <ThemeCard>
            <div class="bg-red-50 border border-red-200 rounded-md p-4">
              <div class="flex">
                <div class="flex-shrink-0">
                  <AlertTriangleIcon class="h-5 w-5 text-red-400" />
                </div>
                <div class="ml-3">
                  <h3 class="text-sm font-medium text-red-800">Ï∞∏Ïó¨Ïú® Îç∞Ïù¥ÌÑ∞ Î°úÎî© Ïò§Î•ò</h3>
                  <div class="mt-2 text-sm text-red-700">
                    <p>{tabErrors.participation}</p>
                    <button
                      type="button"
                      onclick={() => loadTabData('participation')}
                      class="mt-2 text-sm text-red-600 hover:text-red-800 underline"
                    >
                      Îã§Ïãú ÏãúÎèÑ
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </ThemeCard>
        {/if}
        <!-- ÎØ∏Íµ¨ÌòÑ Í∏∞Îä• ÏïàÎÇ¥ -->
        <ThemeCard>
          <div class="bg-blue-50 border border-blue-200 rounded-md p-4">
            <div class="flex">
              <div class="flex-shrink-0">
                <ActivityIcon class="h-5 w-5 text-blue-400" />
              </div>
              <div class="ml-3">
                <h3 class="text-sm font-medium text-blue-800">Í∏∞Îä• Í∞úÎ∞ú Ï§ë</h3>
                <div class="mt-2 text-sm text-blue-700">
                  <p>ÏßÅÏõêÎ≥Ñ Ï∞∏Ïó¨Ïú® Í¥ÄÎ¶¨ Í∏∞Îä•Ïù¥ ÌòÑÏû¨ Í∞úÎ∞ú Ï§ëÏûÖÎãàÎã§.</p>
                  <p class="mt-1">Í≥ß Ï†ïÌôïÌïú Ï∞∏Ïó¨Ïú® Îç∞Ïù¥ÌÑ∞Î•º ÌôïÏù∏Ìï† Ïàò ÏûàÏäµÎãàÎã§.</p>
                </div>
              </div>
            </div>
          </div>
        </ThemeCard>

        <ThemeCard>
          <div class="px-6 py-4 border-b border-gray-200">
            <h3 class="text-lg font-medium text-gray-900">ÏßÅÏõêÎ≥Ñ Ï∞∏Ïó¨Ïú® ÌòÑÌô©</h3>
          </div>
          <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
              <thead class="bg-gray-50">
                <tr>
                  <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ÏßÅÏõê</th>
                  <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Î∂ÄÏÑú</th>
                  <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Ï∞∏Ïó¨ ÌîÑÎ°úÏ†ùÌä∏</th>
                  <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Ï¥ù Ï∞∏Ïó¨Ïú®</th>
                  <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ÏÉÅÌÉú</th>
                </tr>
              </thead>
              <tbody class="bg-white divide-y divide-gray-200">
                {#if employeeParticipationSummary.length > 0}
                  {#each employeeParticipationSummary as employee (employee.email)}
                    <tr class="hover:bg-gray-50">
                      <td class="px-6 py-4 whitespace-nowrap">
                        <div class="text-sm font-medium text-gray-900">{employee.name}</div>
                        <div class="text-sm text-gray-500">{employee.email}</div>
                      </td>
                      <td class="px-6 py-4 whitespace-nowrap">
                        <div class="text-sm text-gray-500">{employee.department}</div>
                      </td>
                      <td class="px-6 py-4 whitespace-nowrap">
                        <div class="text-sm text-gray-900">{employee.activeProjects}Í∞ú</div>
                      </td>
                      <td class="px-6 py-4 whitespace-nowrap">
                        <div class="text-sm text-gray-900">{employee.totalParticipationRate}%</div>
                      </td>
                      <td class="px-6 py-4 whitespace-nowrap">
                        {#if employee.totalParticipationRate > 100}
                          <ThemeBadge variant="error">Ï¥àÍ≥º Ï∞∏Ïó¨</ThemeBadge>
                        {:else if employee.totalParticipationRate === 100}
                          <ThemeBadge variant="success">Ï†ïÏÉÅ</ThemeBadge>
                        {:else}
                          <ThemeBadge variant="info">Ïó¨Ïú†</ThemeBadge>
                        {/if}
                      </td>
                    </tr>
                  {/each}
                {:else}
                  <tr>
                    <td
                      colspan="5"
                      class="px-6 py-12 text-center text-gray-500">
                      <UsersIcon class="mx-auto h-12 w-12 text-gray-400" />
                      <p class="mt-2">Ï∞∏Ïó¨Ïú® Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÏäµÎãàÎã§.</p>
                    </td>
                  </tr>
                {/if}
              </tbody>
            </table>
          </div>
        </ThemeCard>
      </div>
    {/if}
  </div>
</PageLayout>

<!-- ÌîÑÎ°úÏ†ùÌä∏ ÏÉùÏÑ± Î™®Îã¨ -->
<ThemeModal
  open={showCreateProjectModal}
  onclose={() => showCreateProjectModal = false}
>
  <ProjectCreationForm on:projectCreated={handleProjectCreated} />
</ThemeModal>

<!-- ÏòàÏÇ∞ ÏÑ§Ï†ï Î™®Îã¨ -->
{#if selectedProject}
  <ThemeModal
    open={showBudgetModal}
    onclose={() => showBudgetModal = false}
  >
    <div class="px-6 py-4 border-b border-gray-200">
      <h2 class="text-lg font-medium text-gray-900">{selectedProject.title} - ÏòàÏÇ∞ ÏÑ§Ï†ï</h2>
    </div>
    {#await import('$lib/components/project-management/SimpleBudgetForm.svelte')}
      <div class="flex items-center justify-center py-8">
        <div class="animate-spin rounded-full h-6 w-6 border-b-2 border-blue-600"></div>
        <span class="ml-2 text-gray-600">Î°úÎî© Ï§ë...</span>
      </div>
    {:then { default: SimpleBudgetForm }}
      <SimpleBudgetForm
        projectId={selectedProject.id}
        on:budgetSaved={() => {
          showBudgetModal = false;
          // ÏòàÏÇ∞ Ï†ïÎ≥¥ ÏÉàÎ°úÍ≥†Ïπ®ÏùÑ ÏúÑÌï¥ ÌîÑÎ°úÏ†ùÌä∏ Îç∞Ïù¥ÌÑ∞ Îã§Ïãú Î°úÎìú
          loadProjectData();
        }}
      />
    {:catch error}
      <div class="text-center py-8 text-red-600">
        <p>ÏòàÏÇ∞ ÏûÖÎ†• ÌèºÏùÑ Î°úÎìúÌï† Ïàò ÏóÜÏäµÎãàÎã§.</p>
      </div>
    {/await}
  </ThemeModal>
{/if}