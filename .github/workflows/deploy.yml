name: Docker ë°°í¬

on:
  push:
    branches: [main]
  workflow_dispatch:
  workflow_run:
    workflows: ['ci']
    types: [completed]
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: AWS ìê²© ì¦ëª… ì„¤ì •
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ap-northeast-2

      - name: ECR ë¦¬í¬ì§€í† ë¦¬ ìƒì„± (ì¡´ì¬í•˜ì§€ ì•ŠëŠ” ê²½ìš°)
        run: |
          aws ecr describe-repositories --repository-names vws-app --region ap-northeast-2 || \
          aws ecr create-repository \
            --repository-name vws-app \
            --region ap-northeast-2 \
            --image-scanning-configuration scanOnPush=true

      - name: ECR ë¡œê·¸ì¸
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Docker ì´ë¯¸ì§€ ë¹Œë“œ ë° í‘¸ì‹œ
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          ECR_REPOSITORY: vws-app
          IMAGE_TAG: ${{ github.sha }}
        run: |
          # Docker ì´ë¯¸ì§€ ë¹Œë“œ
          echo "Building Docker image..."
          docker build -t $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG .
          docker tag $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG $ECR_REGISTRY/$ECR_REPOSITORY:latest

          # ECRì— í‘¸ì‹œ
          echo "Pushing to ECR..."
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:latest
          echo "Successfully pushed to ECR"

      - name: ECS í´ëŸ¬ìŠ¤í„° ìƒì„± (ì¡´ì¬í•˜ì§€ ì•ŠëŠ” ê²½ìš°)
        run: |
          aws ecs describe-clusters --clusters vws-cluster --region ap-northeast-2 || \
          aws ecs create-cluster \
            --cluster-name vws-cluster \
            --region ap-northeast-2

      - name: ECS ì„œë¹„ìŠ¤ ì—…ë°ì´íŠ¸ (ì„ íƒì‚¬í•­)
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          ECR_REPOSITORY: vws-app
          IMAGE_TAG: ${{ github.sha }}
        continue-on-error: true
        run: |
          # ECS ì„œë¹„ìŠ¤ê°€ ì¡´ì¬í•˜ëŠ”ì§€ í™•ì¸í•˜ê³  ì—…ë°ì´íŠ¸
          if aws ecs describe-services --cluster vws-cluster --services vws-service --region ap-northeast-2 --query 'services[0].status' --output text | grep -q "ACTIVE"; then
            echo "Updating existing ECS service..."
            aws ecs update-service \
              --cluster vws-cluster \
              --service vws-service \
              --force-new-deployment \
              --region ap-northeast-2
            echo "ECS service updated successfully"
          else
            echo "ECS service does not exist. Skipping ECS update."
            echo "Docker image has been built and pushed to ECR successfully."
            echo "You can manually create the ECS service and task definition when ready."
          fi

      - name: ë°°í¬ ì™„ë£Œ ì•Œë¦¼
        if: success()
        uses: 8398a7/action-slack@v3
        with:
          status: success
          channel: '#vws_action'
          text: 'ğŸš€ VWS ì•±ì´ ì„±ê³µì ìœ¼ë¡œ ë°°í¬ë˜ì—ˆìŠµë‹ˆë‹¤!'
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

      - name: ë°°í¬ ì‹¤íŒ¨ ì•Œë¦¼
        if: failure()
        uses: 8398a7/action-slack@v3
        with:
          status: failure
          channel: '#vws_action'
          text: 'âŒ VWS ì•± ë°°í¬ê°€ ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤!'
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
