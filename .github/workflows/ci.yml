name: CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  # === ì½”ë“œ í’ˆì§ˆ ì²´í¬ ===
  quality-check:
    name: ì½”ë“œ í’ˆì§ˆ ì²´í¬
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout ì½”ë“œ
      uses: actions/checkout@v4
      
    - name: Node.js ì„¤ì •
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        
    - name: ì˜ì¡´ì„± ì„¤ì¹˜
      run: npm ci
      
    - name: TypeScript íƒ€ì… ì²´í¬
      run: npm run check
      
    - name: ESLint ì²´í¬
      run: npx eslint src/ --ext .ts,.svelte --max-warnings 0
      
    - name: ë¹Œë“œ í…ŒìŠ¤íŠ¸
      run: npm run build
      
    - name: í…ŒìŠ¤íŠ¸ ì‹¤í–‰ (ìˆëŠ” ê²½ìš°)
      run: npm test || echo "í…ŒìŠ¤íŠ¸ ìŠ¤í¬ë¦½íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤."
      continue-on-error: true
      
    - name: ë³´ì•ˆ ì·¨ì•½ì  ì²´í¬
      run: npm audit --audit-level=high
      continue-on-error: true

  # === ì„±ëŠ¥ í…ŒìŠ¤íŠ¸ ===
  performance-test:
    name: ì„±ëŠ¥ í…ŒìŠ¤íŠ¸
    runs-on: ubuntu-latest
    needs: quality-check
    
    steps:
    - name: Checkout ì½”ë“œ
      uses: actions/checkout@v4
      
    - name: Node.js ì„¤ì •
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        
    - name: ì˜ì¡´ì„± ì„¤ì¹˜
      run: npm ci
      
    - name: ë¹Œë“œ
      run: npm run build
      
    - name: ë²ˆë“¤ í¬ê¸° ì²´í¬
      run: |
        echo "ë²ˆë“¤ í¬ê¸° ì²´í¬..."
        find .svelte-kit -name "*.js" -exec ls -lh {} \; | head -10
        echo "ë²ˆë“¤ í¬ê¸° ì²´í¬ ì™„ë£Œ"

  # === ë³´ì•ˆ ìŠ¤ìº” ===
  security-scan:
    name: ë³´ì•ˆ ìŠ¤ìº”
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout ì½”ë“œ
      uses: actions/checkout@v4
      
    - name: Node.js ì„¤ì •
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        
    - name: ì˜ì¡´ì„± ì„¤ì¹˜
      run: npm ci
      
    - name: npm audit
      run: npm audit --audit-level=moderate
      
    - name: CodeQL ë¶„ì„
      uses: github/codeql-action/init@v3
      with:
        languages: javascript
        
    - name: CodeQL ë¶„ì„ ì‹¤í–‰
      uses: github/codeql-action/analyze@v3

  # === ë°°í¬ ì¤€ë¹„ ===
  deploy-prep:
    name: ë°°í¬ ì¤€ë¹„
    runs-on: ubuntu-latest
    needs: [quality-check, performance-test, security-scan]
    if: github.ref == 'refs/heads/main'
    
    steps:
    - name: Checkout ì½”ë“œ
      uses: actions/checkout@v4
      
    - name: Node.js ì„¤ì •
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        
    - name: ì˜ì¡´ì„± ì„¤ì¹˜
      run: npm ci
      
    - name: í”„ë¡œë•ì…˜ ë¹Œë“œ
      run: npm run build
      
    - name: ë¹Œë“œ ì•„í‹°íŒ©íŠ¸ ì—…ë¡œë“œ
      uses: actions/upload-artifact@v4
      with:
        name: build-artifacts
        path: .svelte-kit/
        retention-days: 30
        
    - name: ë°°í¬ ì¤€ë¹„ ì™„ë£Œ ì•Œë¦¼
      run: |
        echo "âœ… ëª¨ë“  ì²´í¬ í†µê³¼! ë°°í¬ ì¤€ë¹„ ì™„ë£Œ"
        echo "ğŸš€ ë¹Œë“œ ì•„í‹°íŒ©íŠ¸ê°€ ì—…ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤."

  # === ì½”ë“œ ì»¤ë²„ë¦¬ì§€ (ì„ íƒì‚¬í•­) ===
  coverage:
    name: ì½”ë“œ ì»¤ë²„ë¦¬ì§€
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    
    steps:
    - name: Checkout ì½”ë“œ
      uses: actions/checkout@v4
      
    - name: Node.js ì„¤ì •
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        
    - name: ì˜ì¡´ì„± ì„¤ì¹˜
      run: npm ci
      
    - name: í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ë° ì»¤ë²„ë¦¬ì§€ ìˆ˜ì§‘
      run: npm run test:coverage || echo "ì»¤ë²„ë¦¬ì§€ í…ŒìŠ¤íŠ¸ê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤."
      continue-on-error: true
      
    - name: ì»¤ë²„ë¦¬ì§€ ë¦¬í¬íŠ¸ ì—…ë¡œë“œ
      uses: codecov/codecov-action@v4
      with:
        token: ${{ secrets.CODECOV_TOKEN }}
        fail_ci_if_error: false
      continue-on-error: true