name: ìë™ ê²€ì¦ ë° í’ˆì§ˆ ê´€ë¦¬

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]
  schedule:
    - cron: '0 2 * * *'
  workflow_dispatch:

jobs:
  code-quality:
    name: ì½”ë“œ í’ˆì§ˆ ê²€ì‚¬
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - uses: actions/checkout@v4
      - uses: pnpm/action-setup@v4
        with:
          version: 9
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: pnpm
          cache-          cache-          cache-          cache-          cache-          cache-          cache-          came          cache-          cache-          cache-         - name: í¬ë§· ê²€ì‚¬
        run: pnpm run format:check
      - name: íƒ€ì…ì²´      - name: íƒ€ì…ì²´      - name: íƒ€ì…ì²´      - name: íƒ€ì…ì²´      - name: íƒ€ì…ì²´      - name: íƒ€ì…ì²´      - name: íƒ€ì…ì²´      - €ì‚¬
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@v4
      - uses: pnpm/action-setup@v4
        with:
          version: 9
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: pnpm
          cache-dependency-path: pnpm-lock.yaml
      - name: Install
        run: pnpm install --frozen-lockfile
      - name: ë³´ì•ˆ ê°ì‚¬
        run: pnpm run security:audit

  auto-validation:
    name: ìë™ ê²€ì¦ (ì™„í™” ë¦°íŠ¸)
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: [code-quality, security-scan]
    steps:
      - uses: actions/checkout@v4
      - uses: pnpm/action-setup@v4
        with:
          version: 9
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: pnpm
          cache-dependency-path: pnpm-lock.yaml
      - name: Install
        run: pnpm install --frozen-lockfile
      - name: ë¦°íŠ¸(warnings 10 í—ˆìš©)
        run: pnpm run lint --max-warnings 10

  dependency-analysis:
    name: ì˜ì¡´ì„± ë¶„ì„
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - uses: actions/checkout@v4
      - uses: pnpm/action-setup@v4
        with:
          version: 9
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: pnpm
          cache-dependency-path: pnpm-lock.yaml
      - name: Install
        run: pnpm install --frozen-lockfile
      - name: ì˜ì¡´ì„± ë¶„ì„
        run: |
          echo "ğŸ“¦ ì˜ì¡´ì„± ë¶„ì„ ì‹œì‘"
          pnpm ls --depth=0 || true
          echo "âœ… ì˜ì¡´ì„± ë¶„ì„ ì™„ë£Œ"

  notification:
    name: ì•Œë¦¼ ì „ì†¡
    runs-on: ubuntu-latest
    needs: [code-quality, security-scan, auto-validation, dependency-analysis]
    if: always()
    steps:
      - name: ì‹¤íŒ¨í•œ ì¡ ë©”ì‹œì§€ ìƒì„±
        id: mkmsg
        run: |
          msg="âŒ ê²€ì¦ ì‹¤íŒ¨: ${{ github.ref_name }} ë¸Œëœì¹˜ - ì‹¤íŒ¨í•œ ì‘ì—…:"
          add() { [ "$1" = "failure" ] && msg="$msg $2"; }
          add "${{ needs.code-quality.result }}" code-quality
          add "${{ needs.security-scan.result }}" security-scan
          add "${{ needs.auto-validation.result }}" auto-validation
          add "${{ needs.dependency-analysis.result }}" dependency-analysis
          echo "text<<EOF" >> "$GITHUB_OUTPUT"
          echo "$msg" >> "$GITHUB_OUTPUT"
          echo "EOF" >> "$GITHUB_OUTPUT"

      - name: ì„±ê³µ ì•Œë¦¼
        if: ${{ needs.code-quality.result == 'success' && needs.security-scan.result == 'success' && needs.auto-validation.result == 'success' && needs.dependency-analysis.result == 'success' }}
        uses: 8398a7/action-slack@v3
        with:
          status: success
          channel: '#vws_action'
          text: "âœ… ëª¨ë“  ê²€ì¦ í†µê³¼: ${{ github.ref_name }} ë¸Œëœì¹˜"
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

      - name: ì‹¤íŒ¨ ì•Œë¦¼
        if: ${{ needs.code-quality.result == 'failure' || needs.security-scan.result == 'failure' || needs.auto-validation.result == 'failure' || needs.dependency-analysis.result == 'failure' }}
        uses: 8398a7/action-slack@v3
        with:
          status: failure
          channel: '#vws_action'
          text: ${{ steps.mkmsg.outputs.text }}
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
