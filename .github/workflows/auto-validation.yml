name: ìë™ ê²€ì¦ ë° í’ˆì§ˆ ê´€ë¦¬

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  schedule:
    # ë§¤ì¼ ì˜¤ì „ 9ì‹œì— ì‹¤í–‰
    - cron: '0 9 * * *'

jobs:
  auto-validation:
    runs-on: ubuntu-latest
    
    steps:
    - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
      uses: actions/checkout@v4
      
    - name: Node.js ì„¤ì •
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        
    - name: ì˜ì¡´ì„± ì„¤ì¹˜
      run: npm ci
      
    - name: ìë™ ê²€ì¦ ì„œë¹„ìŠ¤ í…ŒìŠ¤íŠ¸
      run: npm run auto-validation:test
      
    - name: ì½”ë“œ í’ˆì§ˆ ê²€ì‚¬
      run: |
        npm run lint:strict
        npm run format:check
        npm run check
        
    - name: ë³´ì•ˆ ê²€ì‚¬
      run: npm run security:audit
      
    - name: ìë™ ê²€ì¦ ì‹¤í–‰
      run: |
        # ë°±ê·¸ë¼ìš´ë“œì—ì„œ ìë™ ê²€ì¦ ì„œë¹„ìŠ¤ ì‹œì‘
        npm run auto-validation:start
        
        # 30ì´ˆ ëŒ€ê¸°
        sleep 30
        
        # ê²€ì¦ ê²°ê³¼ í™•ì¸
        npm run auto-validation:status
        
        # ë¡œê·¸ í™•ì¸
        npm run auto-validation:logs 100
        
        # ì„œë¹„ìŠ¤ ì¤‘ì§€
        npm run auto-validation:stop
        
    - name: í…ŒìŠ¤íŠ¸ ì‹¤í–‰
      run: npm run test:coverage
      
    - name: ë¹Œë“œ í…ŒìŠ¤íŠ¸
      run: npm run build
      
    - name: ê²€ì¦ ê²°ê³¼ ì—…ë¡œë“œ
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: validation-results
        path: |
          logs/
          coverage/
        retention-days: 30
        
    - name: ê²€ì¦ ì‹¤íŒ¨ ì‹œ ì•Œë¦¼
      if: failure()
      uses: 8398a7/action-slack@v3
      with:
        status: failure
        channel: '#dev-alerts'
        text: 'ìë™ ê²€ì¦ ì‹¤íŒ¨: ${{ github.repository }}'
      env:
        SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

  dependency-analysis:
    runs-on: ubuntu-latest
    
    steps:
    - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
      uses: actions/checkout@v4
      
    - name: Node.js ì„¤ì •
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        
    - name: ì˜ì¡´ì„± ì„¤ì¹˜
      run: npm ci
      
    - name: ì˜ì¡´ì„± ë¶„ì„
      run: |
        # ì˜ì¡´ì„± ë¶„ì„ ì‹¤í–‰
        curl -X GET "http://localhost:5173/api/project-management/safe-change-management?action=analyze&scope=project" \
          -H "Content-Type: application/json" \
          -o dependency-analysis.json
          
    - name: ì˜ì¡´ì„± ë¶„ì„ ê²°ê³¼ ì—…ë¡œë“œ
      uses: actions/upload-artifact@v4
      with:
        name: dependency-analysis
        path: dependency-analysis.json
        retention-days: 30

  code-quality:
    runs-on: ubuntu-latest
    
    steps:
    - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
      uses: actions/checkout@v4
      
    - name: Node.js ì„¤ì •
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        
    - name: ì˜ì¡´ì„± ì„¤ì¹˜
      run: npm ci
      
    - name: ì½”ë“œ í’ˆì§ˆ ê²€ì‚¬
      run: |
        # ESLint ê²€ì‚¬
        npm run lint:strict
        
        # Prettier ê²€ì‚¬
        npm run format:check
        
        # TypeScript ê²€ì‚¬
        npm run check
        
        # í’ˆì§ˆ ê²Œì´íŠ¸
        npm run quality:gate
        
    - name: ì½”ë“œ ì»¤ë²„ë¦¬ì§€
      run: npm run test:coverage
      
    - name: ì»¤ë²„ë¦¬ì§€ ë¦¬í¬íŠ¸ ì—…ë¡œë“œ
      uses: codecov/codecov-action@v3
      with:
        file: ./coverage/lcov.info
        flags: unittests
        name: codecov-umbrella
        fail_ci_if_error: false

  security-scan:
    runs-on: ubuntu-latest
    
    steps:
    - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
      uses: actions/checkout@v4
      
    - name: Node.js ì„¤ì •
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        
    - name: ì˜ì¡´ì„± ì„¤ì¹˜
      run: npm ci
      
    - name: ë³´ì•ˆ ê²€ì‚¬
      run: |
        # npm audit
        npm run security:audit
        
        # ì·¨ì•½ì  ìë™ ìˆ˜ì • ì‹œë„
        npm run security:fix
        
    - name: ë³´ì•ˆ ìŠ¤ìº” ê²°ê³¼ ì—…ë¡œë“œ
      uses: actions/upload-artifact@v4
      with:
        name: security-scan-results
        path: |
          npm-audit.json
        retention-days: 30

  notification:
    runs-on: ubuntu-latest
    needs: [auto-validation, dependency-analysis, code-quality, security-scan]
    if: always()
    
    steps:
    - name: ì„±ê³µ ì•Œë¦¼
      if: ${{ needs.auto-validation.result == 'success' && needs.dependency-analysis.result == 'success' && needs.code-quality.result == 'success' && needs.security-scan.result == 'success' }}
      uses: 8398a7/action-slack@v3
      with:
        status: success
        channel: '#dev-success'
        text: 'ëª¨ë“  ìë™ ê²€ì¦ì´ ì„±ê³µí–ˆìŠµë‹ˆë‹¤! ğŸ‰'
      env:
        SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        
    - name: ì‹¤íŒ¨ ì•Œë¦¼
      if: ${{ needs.auto-validation.result == 'failure' || needs.dependency-analysis.result == 'failure' || needs.code-quality.result == 'failure' || needs.security-scan.result == 'failure' }}
      uses: 8398a7/action-slack@v3
      with:
        status: failure
        channel: '#dev-alerts'
        text: 'ìë™ ê²€ì¦ ì¤‘ ì¼ë¶€ê°€ ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. í™•ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.'
      env:
        SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}




