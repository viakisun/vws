name: í’ˆì§ˆ ê²€ì¦

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

jobs:
  quality-check:
    runs-on: ubuntu-latest

    steps:
      - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: Node.js ì„¤ì •
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: ì˜ì¡´ì„± ì„¤ì¹˜
        run: npm ci

      - name: íƒ€ì… ì²´í¬
        run: npm run check

      - name: ë¦°íŠ¸ ê²€ì‚¬ (ìˆ˜ì • ê¸ˆì§€)
        run: npm run lint

      - name: ë°˜ì‘ì„± íŒ¨í„´ ê²€ì¦
        run: |
          echo "ğŸ” ë°˜ì‘ì„± íŒ¨í„´ ê²€ì¦ ì¤‘..."

          # ê¸ˆì§€ëœ íŒ¨í„´ ê²€ì‚¬
          FORBIDDEN_PATTERNS=(
            "\$effect\(\(\) => \{"
            "derivedFunction\(\)"
            ";\("
          )

          ERROR_COUNT=0

          for pattern in "${FORBIDDEN_PATTERNS[@]}"; do
            if grep -r "$pattern" src/ --include="*.svelte" --include="*.ts"; then
              echo "âŒ ê¸ˆì§€ëœ íŒ¨í„´ ë°œê²¬: $pattern"
              echo "   ì´ë²¤íŠ¸ ê¸°ë°˜ ì ‘ê·¼ë²•ì„ ì‚¬ìš©í•˜ì„¸ìš”."
              ERROR_COUNT=$((ERROR_COUNT + 1))
            fi
          done

          # í•„ìˆ˜ íŒ¨í„´ ê²€ì‚¬
          REQUIRED_PATTERNS=(
            "handleFilterChange\|handleChange\|updateData"
          )

          for pattern in "${REQUIRED_PATTERNS[@]}"; do
            if ! grep -r "$pattern" src/ --include="*.svelte" --include="*.ts" > /dev/null; then
              echo "âš ï¸  ê¶Œì¥ íŒ¨í„´ì´ ì—†ìŠµë‹ˆë‹¤: $pattern"
              echo "   ì´ë²¤íŠ¸ ê¸°ë°˜ ì—…ë°ì´íŠ¸ ë©”ì„œë“œë¥¼ ì¶”ê°€í•˜ì„¸ìš”."
            fi
          done

          if [ $ERROR_COUNT -gt 0 ]; then
            echo "ğŸš« í’ˆì§ˆ ê²€ì¦ ì‹¤íŒ¨: ë°˜ì‘ì„± íŒ¨í„´ì„ ìˆ˜ì •í•˜ì„¸ìš”."
            exit 1
          fi

          echo "âœ… ë°˜ì‘ì„± íŒ¨í„´ ê²€ì¦ ì™„ë£Œ"

      - name: ë¹Œë“œ í…ŒìŠ¤íŠ¸
        run: npm run build

      - name: í…ŒìŠ¤íŠ¸ ì‹¤í–‰
        run: npm test

      - name: ì»¤ë²„ë¦¬ì§€ ë¦¬í¬íŠ¸
        run: npm run test:coverage

      - name: ë³´ì•ˆ ê²€ì‚¬
        run: npm audit

      - name: ì˜ì¡´ì„± ê²€ì‚¬
        run: npm outdated
