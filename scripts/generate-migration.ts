#!/usr/bin/env tsx
/**
 * Migration ìƒì„± ìŠ¤í¬ë¦½íŠ¸
 *
 * resources.tsì™€ DBì˜ ì°¨ì´ë¥¼ ë¶„ì„í•˜ì—¬ SQL Migration íŒŒì¼ì„ ìë™ ìƒì„±í•©ë‹ˆë‹¤.
 *
 * Usage:
 *   npm run generate-migration
 *   tsx scripts/generate-migration.ts
 */

import { Pool } from 'pg'
import { writeFileSync, readdirSync } from 'fs'
import { join } from 'path'
import { extractResourcesToSync } from './sync-resources-to-db.js'
import { getResourceData } from '../src/lib/config/resources.js'

// ============================================
// ì„¤ì •
// ============================================

const DB_URL =
  process.env.DATABASE_URL ||
  'postgresql://postgres:viahubdev@db-viahub.cdgqkcss8mpj.ap-northeast-2.rds.amazonaws.com:5432/postgres'

const pool = new Pool({
  connectionString: DB_URL,
  ssl: {
    rejectUnauthorized: false,
  },
})

const ACTIONS = ['read', 'write', 'delete', 'approve'] as const
const MIGRATIONS_DIR = join(process.cwd(), 'migrations')

// ============================================
// ìƒ‰ìƒ ìœ í‹¸ë¦¬í‹°
// ============================================

const colors = {
  reset: '\x1b[0m',
  red: '\x1b[31m',
  green: '\x1b[32m',
  yellow: '\x1b[33m',
  blue: '\x1b[34m',
  magenta: '\x1b[35m',
  cyan: '\x1b[36m',
  bold: '\x1b[1m',
}

function color(text: string, colorCode: string): string {
  return `${colorCode}${text}${colors.reset}`
}

// ============================================
// Migration ë²ˆí˜¸ ìƒì„±
// ============================================

function getNextMigrationNumber(): string {
  const files = readdirSync(MIGRATIONS_DIR)
  const numbers = files.filter((f) => f.match(/^\d{3}_/)).map((f) => parseInt(f.substring(0, 3)))

  const maxNumber = numbers.length > 0 ? Math.max(...numbers) : 0
  return String(maxNumber + 1).padStart(3, '0')
}

// ============================================
// ì•¡ì…˜ëª… í•œê¸€í™”
// ============================================

function getActionNameKo(action: string): string {
  const map: Record<string, string> = {
    read: 'ì¡°íšŒ',
    write: 'ìˆ˜ì •',
    delete: 'ì‚­ì œ',
    approve: 'ìŠ¹ì¸',
  }
  return map[action] || action
}

// ============================================
// ë³€ê²½ì‚¬í•­ ê°ì§€
// ============================================

interface PermissionChange {
  code: string
  resource: string
  action: string
  description: string
  isNew: boolean
}

async function detectChanges(): Promise<PermissionChange[]> {
  console.log(color('\nğŸ” Detecting changes...', colors.cyan))

  // 1. ì½”ë“œì—ì„œ ë¦¬ì†ŒìŠ¤ ì¶”ì¶œ
  const resourceData = getResourceData()
  const resources = extractResourcesToSync(resourceData)
  console.log(color(`   Found ${resources.length} resources in code`, colors.green))

  // 2. DBì—ì„œ ê¸°ì¡´ ê¶Œí•œ ì¡°íšŒ
  const dbPermissions = await pool.query<{ code: string }>('SELECT code FROM permissions')
  const existingCodes = new Set(dbPermissions.rows.map((r) => r.code))
  console.log(color(`   Found ${existingCodes.size} permissions in DB`, colors.green))

  // 3. ë³€ê²½ì‚¬í•­ ìˆ˜ì§‘
  const changes: PermissionChange[] = []

  for (const resource of resources) {
    for (const action of ACTIONS) {
      const code = `${resource.key}.${action}`
      const description = `${resource.nameKo} ${getActionNameKo(action)}`

      if (!existingCodes.has(code)) {
        changes.push({
          code,
          resource: resource.key,
          action,
          description,
          isNew: true,
        })
      }
    }
  }

  console.log(color(`   Found ${changes.length} new permissions to add\n`, colors.yellow))

  return changes
}

// ============================================
// SQL ìƒì„±
// ============================================

function generateSQL(changes: PermissionChange[]): string {
  const timestamp = new Date().toISOString()
  const migrationNumber = getNextMigrationNumber()

  let sql = `-- =============================================
-- Migration ${migrationNumber}: Sync resources from resources.ts
-- Auto-generated: ${timestamp}
-- =============================================
-- 
-- This migration adds missing permissions based on resources.ts
-- Generated by: scripts/generate-migration.ts
-- 
-- Changes:
--   - ${changes.length} new permissions
--   - Auto-assigned to ADMIN role
-- 
-- =============================================

BEGIN;

`

  // ê¶Œí•œ ì¶”ê°€
  if (changes.length > 0) {
    sql += `-- =============================================
-- 1. Add new permissions
-- =============================================

INSERT INTO permissions (code, resource, action, description, scope, is_active)
VALUES
`

    sql += changes
      .map(
        (c) => `  ('${c.code}', '${c.resource}', '${c.action}', '${c.description}', 'all', true)`,
      )
      .join(',\n')

    sql += `
ON CONFLICT (code) DO NOTHING;

`
  }

  // ADMIN í• ë‹¹
  sql += `-- =============================================
-- 2. Assign new permissions to ADMIN role
-- =============================================

INSERT INTO role_permissions (role_id, permission_id)
SELECT 
  (SELECT id FROM roles WHERE code = 'ADMIN'),
  p.id
FROM permissions p
WHERE p.code IN (
`

  if (changes.length > 0) {
    sql += changes.map((c) => `  '${c.code}'`).join(',\n')
  } else {
    sql += `  -- No new permissions`
  }

  sql += `
)
AND NOT EXISTS (
  SELECT 1 FROM role_permissions rp
  WHERE rp.role_id = (SELECT id FROM roles WHERE code = 'ADMIN')
    AND rp.permission_id = p.id
);

`

  // ìºì‹œ ë¬´íš¨í™”
  sql += `-- =============================================
-- 3. Clear permission cache
-- =============================================

DELETE FROM permission_cache;

-- =============================================
-- Complete
-- =============================================

COMMIT;

-- =============================================
-- Verification Query (run after migration)
-- =============================================
-- 
-- SELECT COUNT(*) as total_permissions 
-- FROM permissions;
-- 
-- SELECT r.code, COUNT(rp.id) as permission_count
-- FROM roles r
-- LEFT JOIN role_permissions rp ON r.id = rp.role_id
-- WHERE r.code = 'ADMIN'
-- GROUP BY r.code;
-- 
-- =============================================
`

  return sql
}

// ============================================
// Migration íŒŒì¼ ìƒì„±
// ============================================

function saveMigration(sql: string, migrationNumber: string): string {
  const filename = `${migrationNumber}_sync_resources.sql`
  const filepath = join(MIGRATIONS_DIR, filename)

  writeFileSync(filepath, sql, 'utf-8')

  return filepath
}

// ============================================
// ê²°ê³¼ ì¶œë ¥
// ============================================

function printResults(changes: PermissionChange[], filepath: string) {
  console.log(color('â”'.repeat(60), colors.blue))
  console.log(color('\nğŸ“Š Migration Generation Results:', colors.bold))

  if (changes.length === 0) {
    console.log(color('\nâœ… No changes needed!', colors.green))
    console.log(color('   All resources are already synchronized.', colors.green))
  } else {
    console.log(
      color(`\nğŸ“ Generated migration with ${changes.length} new permissions:`, colors.cyan),
    )
    console.log(color(`   File: ${filepath}`, colors.bold))

    console.log(color('\nğŸ“‹ New permissions:', colors.yellow))
    const byResource = changes.reduce(
      (acc, c) => {
        if (!acc[c.resource]) acc[c.resource] = []
        acc[c.resource].push(c.action)
        return acc
      },
      {} as Record<string, string[]>,
    )

    Object.entries(byResource).forEach(([resource, actions]) => {
      console.log(color(`   â€¢ ${resource}`, colors.bold))
      console.log(color(`     â””â”€ ${actions.join(', ')}`, colors.cyan))
    })

    console.log(color('\nğŸš€ Next steps:', colors.magenta))
    console.log('   1. Review the generated migration file')
    console.log('   2. Test in development environment')
    console.log('   3. Commit and deploy to production')
    console.log(color('\n   Migration file ready for deployment! âœ¨', colors.green))
  }

  console.log(color('\nâ”'.repeat(60), colors.blue))
  console.log('')
}

// ============================================
// ë©”ì¸ ì‹¤í–‰
// ============================================

async function main() {
  try {
    console.log(color('\nğŸ—ï¸  Migration Generator', colors.bold))
    console.log(color('â”'.repeat(60), colors.blue))

    // 1. ë³€ê²½ì‚¬í•­ ê°ì§€
    const changes = await detectChanges()

    if (changes.length === 0) {
      console.log(color('\nâœ… No changes detected. Database is up to date!', colors.green))
      await pool.end()
      process.exit(0)
      return
    }

    // 2. SQL ìƒì„±
    console.log(color('ğŸ“ Generating SQL...', colors.cyan))
    const sql = generateSQL(changes)

    // 3. Migration íŒŒì¼ ì €ì¥
    const migrationNumber = getNextMigrationNumber()
    const filepath = saveMigration(sql, migrationNumber)

    // 4. ê²°ê³¼ ì¶œë ¥
    printResults(changes, filepath)

    await pool.end()
    process.exit(0)
  } catch (error) {
    console.error(color('\nâŒ Error:', colors.red), error)
    await pool.end()
    process.exit(1)
  }
}

// ì§ì ‘ ì‹¤í–‰ ì‹œ (ES ëª¨ë“ˆ)
main()

export { generateSQL, detectChanges }
